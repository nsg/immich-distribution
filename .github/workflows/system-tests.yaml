name: Build and run System Tests

on:
  push:
    branches:
      - 'bump/**'
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'

  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'

  workflow_dispatch:

jobs:
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate vips-modules version
        run: make test-validate -C tests

  build-snap:
    name: Build Snap Package
    runs-on: ubuntu-latest
    needs: validate-config

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Snap build
        id: cache-snap
        uses: actions/cache@v4
        with:
          path: "*.snap"
          key: cache-snap-${{ hashFiles('parts/**', 'snap/**', 'src/**') }}

      - name: Build snap package
        if: steps.cache-snap.outputs.cache-hit != 'true'
        uses: snapcore/action-build@v1
        id: build

      - name: Save snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: development-snap-package
          retention-days: 7
          if-no-files-found: error
          path: "*.snap"

  prep-backup:
    name: Prepare installation and backup state
    runs-on: ubuntu-latest
    timeout-minutes: 10

    needs: build-snap

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: sudo snap install --dangerous *.snap

      - name: TEST | Run Prepare Tests
        timeout-minutes: 10
        run: make test-prep -C tests

      - name: TEST | Run Asset Tests
        timeout-minutes: 10
        run: make test-assets -C tests

      - name: Upload test videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-prep
          retention-days: 7
          path: tests/test-results/videos/

      - name: Backup database and assets
        run: |
          sudo immich-distribution.backup -a -d
          rm -rf ./backups
          cp -rv /var/snap/immich-distribution/common/backups .

      - name: Upload backups and secret.txt
        uses: actions/upload-artifact@v4
        with:
          name: backups
          retention-days: 1
          path: |
            backups
            tests/secret.txt

  prep-backup-store:
    name: Prepare backup state from store package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tests-ran: ${{ steps.check-playwright.outputs.has-playwright }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Check for Playwright test infrastructure
        id: check-playwright
        run: |
          if [ -f "tests/conftest.py" ]; then
            echo "has-playwright=true" >> $GITHUB_OUTPUT
          else
            echo "has-playwright=false" >> $GITHUB_OUTPUT
            echo "Playwright test infrastructure not found - skipping tests (expected on older branches)"
          fi

      - name: TEST | Install package from store
        if: steps.check-playwright.outputs.has-playwright == 'true'
        run: sudo snap install immich-distribution

      - name: Start Playwright server
        if: steps.check-playwright.outputs.has-playwright == 'true'
        run: make playwright-ci -C tests

      - name: TEST | Run Prepare Tests
        if: steps.check-playwright.outputs.has-playwright == 'true'
        timeout-minutes: 10
        run: make test-prep -C tests

      - name: Stop Playwright server
        if: always() && steps.check-playwright.outputs.has-playwright == 'true'
        run: make playwright-ci-stop -C tests

      - name: Backup database and assets
        if: steps.check-playwright.outputs.has-playwright == 'true'
        run: |
          sudo immich-distribution.backup -a -d
          rm -rf ./backups
          cp -rv /var/snap/immich-distribution/common/backups .

      - name: Upload backups and secret.txt
        if: steps.check-playwright.outputs.has-playwright == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backups-store
          retention-days: 1
          path: |
            backups
            tests/secret.txt

      - name: Upload test videos on failure
        if: failure() && steps.check-playwright.outputs.has-playwright == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-prep-backup-store
          retention-days: 7
          path: tests/test-results/videos/

  upgrade:
    name: Upgrade from Store to Development
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: needs.prep-backup-store.outputs.tests-ran == 'true'

    needs: [build-snap, prep-backup-store]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: TEST | Install package from store
        run: sudo snap install immich-distribution

      - name: Download backups artifact
        uses: actions/download-artifact@v4
        with:
          name: backups-store

      - name: Wait Immich Distribution to start
        run: make wait -C tests

      - name: Restore database
        run: |
          sudo cp -rv ./backups/immich_database_*.sql.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -d /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz
          sudo rm /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz

      - name: Restore assets
        run: |
          sudo cp -rv ./backups/immich_assets_*.tar.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -a /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz
          sudo rm /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Upgrade to development package
        run: sudo snap install --dangerous *.snap

      - name: Wait Immich Distribution to restart after upgrade
        run: make wait -C tests

      - name: Backup database and assets after upgrade
        run: |
          sudo immich-distribution.backup -a -d
          rm -rf ./backups
          cp -rv /var/snap/immich-distribution/common/backups .

      - name: Upload post-upgrade backups
        uses: actions/upload-artifact@v4
        with:
          name: backups-upgraded
          retention-days: 1
          path: |
            backups
            tests/secret.txt

  prep:
    name: Prepare & Asset Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    needs: build-snap

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: sudo snap install --dangerous *.snap

      - name: TEST | Run Prepare Tests
        timeout-minutes: 10
        run: make test-prep -C tests

      - name: TEST | Run Photo Tests
        run: make test-photos -C tests

      - name: Upload test videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-prep-standalone
          retention-days: 7
          path: tests/test-results/videos/

  backup:
    name: Built-in Immich Backup Functionality Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    needs: prep-backup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: sudo snap install --dangerous *.snap

      - name: Download backups artifact
        uses: actions/download-artifact@v4
        with:
          name: backups

      - name: Wait Immich Distribution to start
        run: make wait -C tests

      - name: Restore database
        run: |
          sudo cp -rv ./backups/immich_database_*.sql.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -d /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz

      - name: Restore assets
        run: |
          sudo cp -rv ./backups/immich_assets_*.tar.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -a /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz

      - name: TEST | Run Backup Tests
        run: make test-backup -C tests

      - name: Print journal on backup test failure
        if: failure()
        run: |
          echo "Backup test failed. Printing journal logs..."
          sudo journalctl -u snap.immich-distribution.* --no-pager -n 500

  assets:
    name: Test Assets - ${{ matrix.backup-type }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    needs: [prep-backup, upgrade]

    strategy:
      matrix:
        include:
          - backup-type: "development"
            backup-artifact: "backups"
          - backup-type: "upgraded"
            backup-artifact: "backups-upgraded"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: sudo snap install --dangerous *.snap

      - name: Download backups artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.backup-artifact }}

      - name: Wait Immich Distribution to start
        run: make wait -C tests

      - name: Restore database
        run: |
          sudo cp -rv ./backups/immich_database_*.sql.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -d /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz

      - name: Restore assets
        run: |
          sudo cp -rv ./backups/immich_assets_*.tar.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -a /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz

      - name: TEST | Run Photo Tests
        run: make test-photos -C tests

      - name: Upload test videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-assets-${{ matrix.backup-type }}
          retention-days: 7
          path: tests/test-results/videos/

      - name: Backup database and assets after photo tests
        run: |
          sudo immich-distribution.backup -a -d
          rm -rf ./backups
          cp -rv /var/snap/immich-distribution/common/backups .

      - name: Upload assets test state
        uses: actions/upload-artifact@v4
        with:
          name: assets-test-state-${{ matrix.backup-type }}
          retention-days: 1
          path: |
            backups
            tests/secret.txt

  sync:
    name: Test Sync Service - ${{ matrix.backup-type }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    needs: [prep-backup, upgrade]

    strategy:
      matrix:
        include:
          - backup-type: "development"
            backup-artifact: "backups"
          - backup-type: "upgraded"
            backup-artifact: "backups-upgraded"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: |
          sudo snap install --dangerous *.snap

      - name: Download backups artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.backup-artifact }}

      - name: Wait Immich Distribution to start
        run: make wait -C tests

      - name: Restore database
        run: |
          sudo cp -rv ./backups/immich_database_*.sql.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -d /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz

      - name: Restore assets
        run: |
          sudo cp -rv ./backups/immich_assets_*.tar.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -a /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz

      - name: TEST | Run Sync Tests
        run: EXPECTED_INITIAL_IMAGE_COUNT=0 make test-sync -C tests

      - name: Upload test videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-sync-${{ matrix.backup-type }}
          retention-days: 7
          path: tests/test-results/videos/

  cli:
    name: Test CLI - ${{ matrix.backup-type }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    needs: [prep-backup, upgrade]

    strategy:
      matrix:
        include:
          - backup-type: "development"
            backup-artifact: "backups"
          - backup-type: "upgraded"
            backup-artifact: "backups-upgraded"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: |
          sudo snap install --dangerous *.snap

      - name: Download backups artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.backup-artifact }}

      - name: Wait Immich Distribution to start
        run: make wait -C tests

      - name: Restore database
        run: |
          sudo cp -rv ./backups/immich_database_*.sql.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -d /var/snap/immich-distribution/common/backups/immich_database_*.sql.xz

      - name: Restore assets
        run: |
          sudo cp -rv ./backups/immich_assets_*.tar.xz /var/snap/immich-distribution/common/backups
          sudo immich-distribution.restore -y -a /var/snap/immich-distribution/common/backups/immich_assets_*.tar.xz

      - name: TEST | Run CLI Tests
        run: make test-cli -C tests

  certificate-management:
    name: Test Manual Certificate Management
    runs-on: ubuntu-latest
    timeout-minutes: 5

    needs: build-snap

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: development-snap-package

      - name: TEST | Install package
        run: sudo snap install --dangerous *.snap

      - name: Wait for Immich Distribution to start
        run: make wait -C tests

      - name: TEST | Verify default HTTP-only configuration
        run: |
          echo "Testing default HTTP-only behavior..."
          
          # Verify HTTP port 80 is listening
          sudo ss -tlnp | grep ':80 ' || (echo "ERROR: Port 80 not listening" && exit 1)
          
          # Verify HTTPS port 443 is NOT listening (should fail)
          if sudo ss -tlnp | grep ':443 '; then
            echo "ERROR: Port 443 should not be listening in HTTP-only mode"
            exit 1
          fi
          
          # Test HAProxy stats page shows HTTP frontend enabled, HTTPS disabled
          curl -s 'http://localhost/haproxy;csv' | grep -E "^http,FRONTEND" || (echo "ERROR: HTTP frontend not found" && exit 1)
          
          # Verify HTTPS frontend is missing
          if curl -s 'http://localhost/haproxy;csv' | grep -E "^https,FRONTEND"; then
            echo "ERROR: HTTPS frontend should not be present in HTTP-only mode"
            exit 1
          fi
          
          echo "✓ HTTP-only configuration verified"

      - name: TEST | Generate self-signed certificate
        run: |
          echo "Generating self-signed certificate..."
          
          # Create certificate directory (should already exist from configure hook)
          sudo mkdir -p /var/snap/immich-distribution/common/acme/haproxy
          
          # Generate private key
          sudo openssl genrsa -out /var/snap/immich-distribution/common/acme/haproxy/cert.crt.key 2048
          
          # Generate self-signed certificate
          sudo openssl req -new -x509 \
            -key /var/snap/immich-distribution/common/acme/haproxy/cert.crt.key \
            -out /var/snap/immich-distribution/common/acme/haproxy/cert.crt \
            -days 365 \
            -subj "/C=US/ST=TestState/L=TestCity/O=TestOrg/CN=localhost"
          
          # Verify certificate was created and is valid
          sudo openssl x509 -in /var/snap/immich-distribution/common/acme/haproxy/cert.crt -text -noout | grep -q "CN = localhost" || (echo "ERROR: Certificate creation failed" && exit 1)
          
          echo "✓ Self-signed certificate generated successfully"

      - name: TEST | Enable HTTPS and verify dual HTTP/HTTPS operation
        run: |
          echo "Enabling HTTPS with manual certificate..."
          
          # Enable HTTPS (this should restart HAProxy automatically)
          sudo snap set immich-distribution https-enabled="true"
          
          # Wait a moment for HAProxy to restart
          sleep 5
          
          # Verify both HTTP and HTTPS ports are now listening
          sudo ss -tlnp | grep ':80 ' || (echo "ERROR: Port 80 not listening after HTTPS enable" && exit 1)
          sudo ss -tlnp | grep ':443 ' || (echo "ERROR: Port 443 not listening after HTTPS enable" && exit 1)
          
          # Verify HAProxy stats show both frontends enabled
          curl -s 'http://localhost/haproxy;csv' | grep -E "^http,FRONTEND" || (echo "ERROR: HTTP frontend not found" && exit 1)
          curl -s 'http://localhost/haproxy;csv' | grep -E "^https,FRONTEND" || (echo "ERROR: HTTPS frontend not found" && exit 1)
          
          echo "✓ Dual HTTP/HTTPS operation verified"

      - name: TEST | Disable HTTP and verify HTTPS-only operation
        run: |
          echo "Disabling HTTP frontend for HTTPS-only operation..."
          
          # Disable HTTP frontend
          sudo snap set immich-distribution http-enabled="false"
          
          # Wait a moment for HAProxy to restart
          sleep 5
          
          # Verify port 80 is closed
          if sudo ss -tlnp | grep ':80 '; then
            echo "ERROR: Port 80 should not be listening in HTTPS-only mode"
            exit 1
          fi
          
          # Verify HTTPS port is still listening
          sudo ss -tlnp | grep ':443 ' || (echo "ERROR: Port 443 not listening after HTTP disable" && exit 1)
          
          # Verify HAProxy stats show HTTP frontend disabled, HTTPS enabled
          # Access stats via HTTPS since HTTP is disabled
          curl -k -s 'https://localhost/haproxy;csv' | grep -E "^https,FRONTEND" || (echo "ERROR: HTTPS frontend not found" && exit 1)
          
          # Verify HTTP frontend is missing
          if curl -k -s 'https://localhost/haproxy;csv' | grep -E "^http,FRONTEND"; then
            echo "ERROR: HTTP frontend should not be present in HTTPS-only mode"
            exit 1
          fi
          
          echo "✓ HTTPS-only operation verified"

