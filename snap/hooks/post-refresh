#!/bin/bash

# Add this file to ignore the checks in this hook
[ -e "$SNAP_COMMON/no-post-refresh-hook" ] && exit 0

. $SNAP/bin/load-env

set -e
PREV_REV="$(snapctl get previous.revision || true)"
PREV_ERA="$(snapctl get previous.era || true)"

# Fallback: if previous.era isn't set, assume era 0
if [ -z "$PREV_ERA" ]; then
	PREV_ERA="0"
fi

# Ensure first-time upgrades without pre-refresh don't fail downgrade check
if [ -z "$PREV_REV" ]; then
	PREV_REV="0"
fi

DIFF=$(( IMMICH_DISTRIBUTION_ERA - PREV_ERA ))
if [ "$DIFF" -gt 1 ]; then
	echo "ERROR: Update skips eras (from $PREV_ERA to $IMMICH_DISTRIBUTION_ERA)." >&2
	echo "Direct upgrades across multiple eras are unsupported." >&2
	echo "See: https://immich-distribution.nsg.cc/install/upgrade-from-old-releases" >&2
	exit 1
fi

# Block downgrades by revision
if [ "$SNAP_REVISION" -lt "$PREV_REV" ]; then
	echo "ERROR: Downgrades are not supported (from $PREV_REV to $SNAP_REVISION)." >&2
	exit 1
fi

exit 0
