#!/bin/bash

# Add this file to ignore the checks in this hook
[ -e "$SNAP_COMMON/no-post-refresh-hook" ] && exit 0

. $SNAP/bin/load-env

# Block large revision jumps (>5) unless override file exists
PREV_REV="$(snapctl get previous.revision || true)"
if [ -n "$PREV_REV" ] && [ -n "$SNAP_REVISION" ]; then
	if [ "$PREV_REV" -gt 0 ] 2>/dev/null; then
		DIFF=$((SNAP_REVISION - PREV_REV))
		if [ "$DIFF" -gt 5 ]; then
			echo "ERROR: Update spans $DIFF revisions (from $PREV_REV to $SNAP_REVISION)." >&2
			echo "This large jump is unsupported. See: https://immich-distribution.nsg.cc/install/upgrade-from-old-releases" >&2
			exit 1
		fi
	fi
fi

exit 0
