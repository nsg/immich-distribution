#!/bin/bash

if [ -z $SNAP ]; then
    . src/bin/sync
else
    . $SNAP/bin/sync
fi

block_sync_enabled
block_immich_server_ready

if [ ! -z $SNAP ]; then
    while ! $SNAP/usr/local/pgsql/bin/pg_isready 2>&1 > /dev/null; do
        echo "Postgres not ready yet, waiting ..."
        sleep 2
    done

    cat $SNAP/etc/modify-db.sql | query_db
fi

for KEY in $(get_keys); do
    {
        USER_ID="$(user_id $KEY)"

        if [ ! -z "$USER_ID" ]; then
            USER_PATH="$SNAP_COMMON/sync/$USER_ID"
            mkdir -p "$USER_PATH"

            {
                echo "Initial import of $USER_PATH ..."
                find "$USER_PATH" -type f | while read -r file_path; do
                    if ! ignore_path "$file_path"; then
                        file_hash="$(sha1sum "$file_path")"
                        file_hash="${file_hash%% *}"
                        user_id="$(extract_user_id_from_path "$file_path")"
                        path="$(extract_relative_path "$file_path")"

                        echo "Import: $path (user: $user_id, hash: $file_hash)"
                        save_hash_to_db "$user_id" "$path" "$file_hash"
                    fi
                done
            }

            echo "Watching Immich database for deleted images ..."
            while sleep 10; do
                record="$(last_removed_file_by_user_from_immich_db "$USER_ID")"

                if [ -z "$record" ]; then
                    continue
                fi

                file_path="$(echo "$record" | cut -d '|' -f 1)"
                asset_id="$(echo "$record" | cut -d '|' -f 2)"

                if [ -e "$USER_PATH/$file_path" ]; then
                    echo "Deleting $USER_PATH/$file_path"
                    if rm "$USER_PATH/$file_path"; then
                        mark_file_as_removed_in_immich_db "$asset_id"
                    fi
                else
                    echo "File $USER_PATH/$file_path already deleted. Set asset $asset_id as removed in database."
                    mark_file_as_removed_in_immich_db "$asset_id"
                fi
            done
        fi
    } &
done
wait
