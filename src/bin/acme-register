#!/bin/bash

. $SNAP/bin/load-env

root_check

register_account() {
    mkdir -p "$ACME_CONFIG_PATH/private"
    $SNAP/usr/local/bin/uacme $(uacme_staging_string) --confdir "$ACME_CONFIG_PATH" new
}

if [ -e "$ACME_CONFIG_PATH/private/key.pem" ]; then
    echo "Account already created, to start over remove $ACME_CONFIG_PATH"
    if [ -z "$ACME_DOMAIN" ]; then
        echo "Configure a domain with 'snap set immich-distribution acme-domain=\"example.com\"'"
    fi
else
    echo "No local ACME account found, this will register an account. Press ctrl-c to abort."
    if [ x$ACME_STAGING == xtrue ]; then
        echo "Using the Let's Encrypt Staging Environment"
    fi
    register_account
fi
