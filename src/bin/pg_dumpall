#!/bin/bash
set -eo pipefail

if [ -z "$SNAP" ]; then
    if [ -e "/snap/immich-distribution/current" ]; then
        export SNAP=$(readlink -f /snap/immich-distribution/current)
        echo "SNAP not defined, using $SNAP" >&2
    else
        echo "Error: SNAP environment variable is not defined and couldn't find /snap/immich-distribution/current" >&2
        exit 1
    fi
fi

if [ -z "$SNAP_COMMON" ]; then
    export SNAP_COMMON="/var/snap/immich-distribution/common"
fi

export LD_LIBRARY_PATH="$SNAP/usr/local/pgsql/lib:$LD_LIBRARY_PATH"
export PATH="$SNAP/usr/local/bin:$PATH"
export PGDATA="$SNAP_COMMON/pgsql/data"
export LC_ALL="C"
export LC_CTYPE="C"

exec $SNAP/usr/local/pgsql/bin/pg_dumpall $@
