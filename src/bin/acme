#!/bin/bash

. $SNAP/bin/load-env

ACME_PIDFILE="$SNAP_COMMON/acme/challenge.pid"

new_certificate() {
    $SNAP/usr/local/bin/uacme $(uacme_staging_string) --verbose --confdir "$ACME_CONFIG_PATH" --hook "$SNAP/bin/renew-acme-hook" issue "$1"
}

expose_acme_challenge() {
    python -m http.server 8081 --bind 127.0.0.1 --directory $SNAP_COMMON/acme/challenge &
    echo $! > $ACME_PIDFILE
}

if [ -z "$ACME_DOMAIN" ]; then
    echo "No domain configured, set a domain with 'snap set immich-distribution acme-domain=\"example.com\"'"
    exit 1
fi

if [ x$ACME_STAGING == xtrue ]; then
    echo "Using the Let's Encrypt Staging Environment"
fi

expose_acme_challenge
new_certificate "$ACME_DOMAIN"
pkill --pidfile $ACME_PIDFILE
