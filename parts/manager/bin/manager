#!/bin/bash
set -eu -o pipefail

. $SNAP/bin/load-env
. $SNAP/etc/manager.conf

send_system_notification() {
    local title="$1"
    local description="$2"
    local use_cache="${3:-true}"
    
    if [ "$use_cache" = "true" ]; then
        local notification_hash=$(echo -n "$title$description" | sha256sum | cut -d' ' -f1)
        local sent_hash=$(snapctl get sent-notification-hash)
        
        if [ "$sent_hash" = "$notification_hash" ]; then
            return 0
        fi
    fi
    
    if $SNAP/bin/notification -t "$title" -T "SystemMessage" -l "info" -D "$description"; then
        if [ "$use_cache" = "true" ]; then
            local notification_hash=$(echo -n "$title$description" | sha256sum | cut -d' ' -f1)
            snapctl set sent-notification-hash="$notification_hash"
        fi
        return 0
    else
        echo "Failed to send system notification: $title" >&2
        return 1
    fi
}

create_api_key() {
    if API_KEY_OUTPUT=$($SNAP/bin/immich-admin create-api-key --name "immich-distribution" --check); then
        if [[ ${#API_KEY_OUTPUT} -gt 30 ]]; then
            snapctl set admin-api-key="$API_KEY_OUTPUT"
        fi
    else
        echo "Failed to create/check API key" >&2
    fi
}

if [[ "${1:-}" == "bootstrap" ]]; then
    echo "Bootstrap: Waiting for Immich server to be ready..."
    
    # Wait up to 10 minutes for the server to be ready
    for i in {1..120}; do
        if immich_server_ready; then
            echo "Bootstrap: Creating admin API key..."
            create_api_key
            exit 0
        fi
        echo "Bootstrap: Waiting for server... (attempt $i/120)"
        sleep 5
    done
    
    echo "Bootstrap: Timeout waiting for Immich server to be ready" >&2
    exit 1
fi

# Check API key twice daily (06:00 and 18:00) - critical for snap operation
CURRENT_HOUR=$(date +%H)
if [[ "$CURRENT_HOUR" == "06" || "$CURRENT_HOUR" == "18" ]]; then
    create_api_key
fi

send_system_notification "$NOTIFICATION_TITLE" "$NOTIFICATION_DESCRIPTION"
